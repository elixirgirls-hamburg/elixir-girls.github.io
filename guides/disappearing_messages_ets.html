<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Elixir Girls Guides Slackir App Disappearing messages - ETS</title>

    <link href="/stylesheets/normalize.css" rel="stylesheet" /><link href="/stylesheets/all.css" rel="stylesheet" />

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Elixir Girls website">
    <meta name="author" content="Cath Jones">

    <!-- Open Graph data -->
    <meta property="og:title" content="Elixir Girls" />
    <meta property="og:type" content="event" />
    <meta property="og:url" content="http://elixirgirls.com" />
    <meta property="og:image" content="http://elixirgirls.com/img/header.jpg" />
    <meta property="og:description" content="Our aim is to make technology more approachable by creating a fun and friendly environment for people to come together and learn about Elixir, Phoenix and Functional Programming" />

    <!-- Bootstrap Core CSS -->
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>

    <!-- Plugin CSS -->
    <link href="/vendor/magnific-popup/magnific-popup.css" rel="stylesheet">

    <!-- Theme CSS -->
    <link href="/stylesheets/creative.css" rel="stylesheet">
    <link href="/stylesheets/highlighting.css" rel="stylesheet" />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

  <body class="guides guides_disappearing_messages_ets">
      <nav id="mainNav" class="navbar navbar-default navbar-fixed-top guide-nav-bar">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span> Menu <i class="fa fa-bars"></i>
            </button>
            <a class="navbar-brand page-scroll" href="/#page-top">Elixir Girls</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="page-scroll" href="/#about">About</a>
                </li>
                <li>
                    <a class="page-scroll" href="/#events">Events</a>
                </li>
                <li>
                    <a class="page-scroll" href="/guides/">Guides</a>
                </li>
                <li>
                    <a class="page-scroll" href="/#sponsors">Sponsors</a>
                </li>
                <li>
                    <a class="page-scroll" href="/#contact">Contact</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container-fluid -->
</nav>

  <div id="wrapper">
    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">Elixir Girls Guides</a>
    </div>
    <!-- /.navbar-header -->

    <!-- /.navbar-top-links -->

    <div class="navbar-default sidebar" role="navigation">
        <div class="sidebar-nav">
            <ul class="nav" id="side-menu nav">
                <li>
                    <a id="dropdown-menu" class="installation" href="#">Installation</a>
                    <ul id="installation" class="nav nav-second-level">
                      <li>
                          <a href="/install-guides/mac.html">Mac</a>
                      </li>
                      <li>
                          <a href="/install-guides/windows.html">Windows</a>
                      </li>
                      <li>
                          <a href="/install-guides/linux.html">Linux</a>
                      </li>
                    </ul>
                </li>
                <li>
                    <a href="/install-guides/dev-tools.html">Additional Tools</a>
                </li>
                <li>
                  <a href="/guides/elixir-beginners-guide.html">Beginner's Guide</a>
                </li>
                <li>
                    <a id="dropdown-menu" class="app-basic" href="#">Slackir App (Basic)</a>
                    <ul id="app-basic" class="nav nav-second-level">
                        <li>
                            <a href="/guides/slackir.html">1. Setting up</a>
                        </li>
                        <li>
                            <a href="/guides/channels.html">2. Channels</a>
                        </li>
                        <li>
                            <a href="/guides/persistence.html">3. Persistence (save)</a>
                        </li>
                        <li>
                            <a href="/guides/retrieve_message_history.html">4. Persistence (fetch)</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a id="dropdown-menu" class="app-advanced" href="#">Slackir App (Advanced)</a>
                    <ul id="app-advanced" class="nav nav-second-level">
                    <li>
                        <a href="/guides/disappearing_messages_ets.html">5. Disappearing messages - ETS</a>
                    </li>
                    <li>
                        <a href="#">6. Expiring messages - GenServers (comming soon)</a>
                    </li>
                    </ul>
                </li>
                <li>
                    <a href="/guides/version-control-git.html">Version Control (Git)</a>
                </li>
                <li>
                    <a href="/guides/deploy-on-heroku.html">Deploy on Heroku</a>
                </li>
            </ul>
        </div>
        <!-- /.sidebar-collapse -->
    </div>
    <!-- /.navbar-static-side -->
</nav>

    <div id="page-wrapper">
      <h1>Disappearing messages - ETS</h1>
<p>We are going to add a snapchat-like disappearing messages using OTP built-in Erlang Term Storage (ETS). ETS is a robust in-memory store for Elixir and Erlang objects that comes included. ETS is capable of storing large amounts of data and offers constant time data access. Tables in ETS are created and owned by individual processes. When an owner process terminates, its tables are destroyed. By default, ETS is limited to 1400 tables per node. If you come from a Ruby world you can treat ETS as an equivalent of Redis key-value store.</p>

<p>First of all, we need to create ETS table on application startup. Add private init function to  <code>lib/slackir/application.ex</code></p>

<div class="highlight"><pre class="highlight elixir"><code><span class="k">defp</span> <span class="n">init_ets</span><span class="p">()</span> <span class="k">do</span>
  <span class="ss">:ets</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:disappearing_messages_table</span><span class="p">,</span> <span class="p">[</span><span class="ss">:set</span><span class="p">,</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:named_table</span><span class="p">])</span>
<span class="k">end</span>
</code></pre></div>
<p>Then call this funtion in <code>start()</code> function callback. This function should look like that:</p>

<div class="highlight"><pre class="highlight elixir"><code><span class="k">def</span> <span class="n">start</span><span class="p">(</span><span class="n">_type</span><span class="p">,</span> <span class="n">_args</span><span class="p">)</span> <span class="k">do</span>
  <span class="kn">import</span> <span class="no">Supervisor</span><span class="o">.</span><span class="no">Spec</span>

  <span class="c1"># Define workers and child supervisors to be supervised</span>
  <span class="n">children</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Start the Ecto repository</span>
    <span class="n">supervisor</span><span class="p">(</span><span class="no">Slackir</span><span class="o">.</span><span class="no">Repo</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="c1"># Start the endpoint when the application starts</span>
    <span class="n">supervisor</span><span class="p">(</span><span class="no">SlackirWeb</span><span class="o">.</span><span class="no">Endpoint</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="c1"># Start your own worker by calling: Slackir.Worker.start_link(arg1, arg2, arg3)</span>
    <span class="c1"># worker(Slackir.Worker, [arg1, arg2, arg3]),</span>
  <span class="p">]</span>

  <span class="c1"># See https://hexdocs.pm/elixir/Supervisor.html</span>
  <span class="c1"># for other strategies and supported options</span>
  <span class="n">opts</span> <span class="o">=</span> <span class="p">[</span><span class="ss">strategy:</span> <span class="ss">:one_for_one</span><span class="p">,</span> <span class="ss">name:</span> <span class="no">Slackir</span><span class="o">.</span><span class="no">Supervisor</span><span class="p">]</span>
  <span class="n">init_ets</span><span class="p">()</span>
  <span class="no">Supervisor</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>Now we need to add information in message form about disappearing. Lets add a checkbox in <code>lib/slackir_web/templates/page/index.html.eex</code></p>

<p>The content of this file should look like that:</p>

<div class="highlight"><pre class="highlight html"><code><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">'message-list'</span> <span class="na">class=</span><span class="s">'row'</span><span class="nt">&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'row form-group'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'col-md-3'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">'text'</span> <span class="na">id=</span><span class="s">'name'</span> <span class="na">class=</span><span class="s">'form-control'</span> <span class="na">placeholder=</span><span class="s">'Name'</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">'col-md-9'</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">'text'</span> <span class="na">id=</span><span class="s">'message'</span> <span class="na">class=</span><span class="s">'form-control'</span> <span class="na">placeholder=</span><span class="s">'Message'</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">'checkbox'</span> <span class="na">id=</span><span class="s">'disappear'</span> <span class="na">class=</span><span class="s">'form-control'</span><span class="nt">&gt;</span>Disappear
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div>
<p>In the next step we need to pass the value of added checkbox to a server through WebSockets. To achieve this lets edit  <code>assets/js/socket.js</code></p>

<p>A new variable <code>let disappear</code> will store a value of the checkbox. Then we need to update action which is responsible for sending a message:</p>

<div class="highlight"><pre class="highlight javascript"><code><span class="nx">channel</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'shout'</span><span class="p">,</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="nx">name</span><span class="p">.</span><span class="nx">val</span><span class="p">(),</span> <span class="na">message</span><span class="p">:</span> <span class="nx">message</span><span class="p">.</span><span class="nx">val</span><span class="p">(),</span> <span class="na">disappear</span><span class="p">:</span> <span class="nx">disappear</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">':checked'</span><span class="p">)</span> <span class="p">});</span>
</code></pre></div>
<p>The whole file should look like that:</p>

<div class="highlight"><pre class="highlight javascript"><code><span class="nx">socket</span><span class="p">.</span><span class="nx">connect</span><span class="p">()</span>
<span class="kd">let</span> <span class="nx">channel</span>   <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">channel</span><span class="p">(</span><span class="s2">"random:lobby"</span><span class="p">,</span> <span class="p">{});</span>
<span class="kd">let</span> <span class="nx">list</span>      <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#message-list'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">message</span>   <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#message'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">name</span>      <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#name'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">disappear</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#disappear'</span><span class="p">);</span>

<span class="nx">message</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'keypress'</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">channel</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'shout'</span><span class="p">,</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="nx">name</span><span class="p">.</span><span class="nx">val</span><span class="p">(),</span> <span class="na">message</span><span class="p">:</span> <span class="nx">message</span><span class="p">.</span><span class="nx">val</span><span class="p">(),</span> <span class="na">disappear</span><span class="p">:</span> <span class="nx">disappear</span><span class="p">.</span><span class="nx">is</span><span class="p">(</span><span class="s1">':checked'</span><span class="p">)</span> <span class="p">});</span>
    <span class="nx">message</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">channel</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'shout'</span><span class="p">,</span> <span class="nx">payload</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">list</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">`&lt;b&gt;</span><span class="p">${</span><span class="nx">payload</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">'Anonymous'</span><span class="p">}</span><span class="s2">:&lt;/b&gt; </span><span class="p">${</span><span class="nx">payload</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span><span class="s2">&lt;br&gt;`</span><span class="p">);</span>
  <span class="nx">list</span><span class="p">.</span><span class="nx">prop</span><span class="p">({</span><span class="na">scrollTop</span><span class="p">:</span> <span class="nx">list</span><span class="p">.</span><span class="nx">prop</span><span class="p">(</span><span class="s2">"scrollHeight"</span><span class="p">)});</span>
<span class="p">});</span>

<span class="nx">channel</span><span class="p">.</span><span class="nx">join</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">receive</span><span class="p">(</span><span class="s2">"ok"</span><span class="p">,</span> <span class="nx">resp</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Joined successfully"</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">})</span>
  <span class="p">.</span><span class="nx">receive</span><span class="p">(</span><span class="s2">"error"</span><span class="p">,</span> <span class="nx">resp</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Unable to join"</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">})</span>

<span class="nx">channel</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'messages_history'</span><span class="p">,</span> <span class="nx">messages</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">messages_list</span> <span class="o">=</span> <span class="nx">messages</span><span class="p">[</span><span class="s2">"messages"</span><span class="p">];</span>

  <span class="nx">messages_list</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">list</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">`&lt;b&gt;</span><span class="p">${</span><span class="nx">msg</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">||</span> <span class="s1">'Anonymous'</span><span class="p">}</span><span class="s2">:&lt;/b&gt; </span><span class="p">${</span><span class="nx">msg</span><span class="p">[</span><span class="s2">"message"</span><span class="p">]}</span><span class="s2">&lt;br&gt;`</span><span class="p">);</span>
    <span class="nx">list</span><span class="p">.</span><span class="nx">prop</span><span class="p">({</span><span class="na">scrollTop</span><span class="p">:</span> <span class="nx">list</span><span class="p">.</span><span class="nx">prop</span><span class="p">(</span><span class="s2">"scrollHeight"</span><span class="p">)});</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">socket</span>
</code></pre></div>
<p>We can now modify <code>lib/slackir/web/channels/random_channel.ex</code> to handle new data.</p>

<p>In order to handle it with the Elixir-way, we need to change this function <code>def handle_in("shout", payload, socket) do</code> to pattern match when disappear param is false:</p>

<div class="highlight"><pre class="highlight elixir"><code><span class="k">def</span> <span class="n">handle_in</span><span class="p">(</span><span class="sd">"</span><span class="s2">shout"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">disappear:</span> <span class="no">false</span><span class="p">}</span> <span class="o">=</span> <span class="n">payload</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">spawn</span><span class="p">(</span><span class="no">Slackir</span><span class="o">.</span><span class="no">Conversations</span><span class="p">,</span> <span class="ss">:create_message</span><span class="p">,</span> <span class="p">[</span><span class="n">payload</span><span class="p">])</span>
  <span class="n">broadcast</span> <span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">shout"</span><span class="p">,</span> <span class="n">payload</span>
  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p>Then we can add next version of this function which will handle <code>%{disappear: true}</code> case, but this time saving it in ETS table.</p>

<div class="highlight"><pre class="highlight elixir"><code><span class="k">def</span> <span class="n">handle_in</span><span class="p">(</span><span class="sd">"</span><span class="s2">shout"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">disappear:</span> <span class="no">true</span><span class="p">}</span> <span class="o">=</span> <span class="n">payload</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">spawn</span><span class="p">(</span><span class="ss">:ets</span><span class="p">,</span> <span class="ss">:insert</span><span class="p">,</span> <span class="p">[</span><span class="ss">:disappearing_messages_table</span><span class="p">,</span> <span class="p">{</span><span class="no">NaiveDateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="p">(),</span> <span class="n">payload</span><span class="p">[</span><span class="sd">"</span><span class="s2">name"</span><span class="p">],</span> <span class="n">payload</span><span class="p">[</span><span class="sd">"</span><span class="s2">message"</span><span class="p">]}])</span>
  <span class="n">broadcast</span> <span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">shout"</span><span class="p">,</span> <span class="n">payload</span>
  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p>This line should be explained by a mentor <code>spawn(:ets, :insert, [:disappearing_messages_table, {NaiveDateTime.utc_now(), payload["name"], payload["message"]}])</code>. Basically, we are spawning a process which will insert our name and message into <code>disappearing_messages_table</code> in ETS along with a DateTime. Watch out for <code>NaiveDateTime.utc_now()</code>. This is added as a first element in a tuple because each key needs to be unique.</p>

<p>Next step is to retrieve all this disappearing messages in <code>def handle_info(:after_join, socket) do</code> function accordingly:</p>

<div class="highlight"><pre class="highlight elixir"><code><span class="k">def</span> <span class="n">handle_info</span><span class="p">(</span><span class="ss">:after_join</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">messages</span> <span class="o">=</span>
    <span class="no">Slackir</span><span class="o">.</span><span class="no">Conversations</span><span class="o">.</span><span class="n">list_messages</span><span class="p">()</span>
    <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(%{</span><span class="ss">message:</span> <span class="nv">&amp;1</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="ss">name:</span> <span class="nv">&amp;1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">disappear:</span> <span class="no">false</span><span class="p">,</span> <span class="ss">timestamp:</span> <span class="nv">&amp;1</span><span class="o">.</span><span class="n">inserted_at</span><span class="p">}))</span>
  <span class="n">messages_ets</span> <span class="o">=</span>
    <span class="ss">:ets</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="ss">:disappearing_messages_table</span><span class="p">,</span> <span class="p">{</span><span class="ss">:"$1"</span><span class="p">,</span> <span class="ss">:"$2"</span><span class="p">,</span> <span class="ss">:"$3"</span><span class="p">})</span>
    <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(%{</span><span class="ss">message:</span> <span class="no">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="nv">&amp;1</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span> <span class="ss">name:</span> <span class="no">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="nv">&amp;1</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="ss">disappear:</span> <span class="no">true</span><span class="p">,</span> <span class="ss">timestamp:</span> <span class="no">Enum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="nv">&amp;1</span><span class="p">,</span> <span class="m">0</span><span class="p">)}))</span>

  <span class="n">messages</span> <span class="o">=</span>
    <span class="n">messages</span> <span class="o">++</span> <span class="n">messages_ets</span>
    <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="no">NaiveDateTime</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="nv">&amp;1</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="nv">&amp;2</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">==</span> <span class="ss">:lt</span><span class="p">))</span>

  <span class="n">push</span> <span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">messages_history"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">messages:</span> <span class="n">messages</span><span class="p">}</span>
  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p>In this block of code, we fetched the data from ETS table <code>:disappearing_messages_table</code> by using this line <code>:ets.match(:disappearing_messages_table, {:"$1", :"$2", :"$3"})</code> and then just mapped to corresponding structure. We updated also a message structure with <code>:disappear</code> key to distinguish both types of messages and also <code>:timestamp</code>. Afterward, we concatenate two lists of messages and sort them by timestamp (If necessary this operation can be explained in details by mentors).</p>

<p>The last thing that we need to do is a visual side, just to have the difference between the two types of messages. Let's go again to <code>assets/js/socket.js</code>. We need to update two things.</p>

<p>Firstly, let's change retrieving a <code>messages_history</code> and indicate temporary message with a red color font.</p>

<div class="highlight"><pre class="highlight javascript"><code><span class="nx">channel</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'messages_history'</span><span class="p">,</span> <span class="nx">messages</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">messages_list</span> <span class="o">=</span> <span class="nx">messages</span><span class="p">[</span><span class="s2">"messages"</span><span class="p">];</span>

  <span class="nx">messages_list</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">line_message</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">[</span><span class="s2">"disappear"</span><span class="p">])</span> <span class="p">{</span>
      <span class="nx">line_message</span> <span class="o">=</span> <span class="s2">`&lt;b&gt;</span><span class="p">${</span><span class="nx">msg</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">||</span> <span class="s1">'Anonymous'</span><span class="p">}</span><span class="s2">:&lt;/b&gt; &lt;font color="red"&gt;</span><span class="p">${</span><span class="nx">msg</span><span class="p">[</span><span class="s2">"message"</span><span class="p">]}</span><span class="s2">&lt;/font&gt;&lt;br&gt;`</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">line_message</span> <span class="o">=</span> <span class="s2">`&lt;b&gt;</span><span class="p">${</span><span class="nx">msg</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">||</span> <span class="s1">'Anonymous'</span><span class="p">}</span><span class="s2">:&lt;/b&gt; </span><span class="p">${</span><span class="nx">msg</span><span class="p">[</span><span class="s2">"message"</span><span class="p">]}</span><span class="s2">&lt;br&gt;`</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">list</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">line_message</span><span class="p">);</span>
    <span class="nx">list</span><span class="p">.</span><span class="nx">prop</span><span class="p">({</span><span class="na">scrollTop</span><span class="p">:</span> <span class="nx">list</span><span class="p">.</span><span class="nx">prop</span><span class="p">(</span><span class="s2">"scrollHeight"</span><span class="p">)});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>Secondly, the same change with handling <code>shout</code> message.</p>

<div class="highlight"><pre class="highlight javascript"><code><span class="nx">channel</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'shout'</span><span class="p">,</span> <span class="nx">payload</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">line_message</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">disappear</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">line_message</span> <span class="o">=</span> <span class="s2">`&lt;b&gt;</span><span class="p">${</span><span class="nx">payload</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">'Anonymous'</span><span class="p">}</span><span class="s2">:&lt;/b&gt; &lt;font color="red"&gt;</span><span class="p">${</span><span class="nx">payload</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span><span class="s2">&lt;/font&gt;&lt;br&gt;`</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">line_message</span> <span class="o">=</span> <span class="s2">`&lt;b&gt;</span><span class="p">${</span><span class="nx">payload</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">'Anonymous'</span><span class="p">}</span><span class="s2">:&lt;/b&gt; </span><span class="p">${</span><span class="nx">payload</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span><span class="s2">&lt;br&gt;`</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">list</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">line_message</span><span class="p">);</span>
  <span class="nx">list</span><span class="p">.</span><span class="nx">prop</span><span class="p">({</span><span class="na">scrollTop</span><span class="p">:</span> <span class="nx">list</span><span class="p">.</span><span class="nx">prop</span><span class="p">(</span><span class="s2">"scrollHeight"</span><span class="p">)});</span>
<span class="p">});</span>

</code></pre></div>
<p>This was the final step. Now we can test if it works correctly. Run the app and send both types of messages. Then run the app in a new tab. Both types of messages should be fetched. Now when you rerun your app and refresh the browser you should see only permanent messages.</p>

<p>In the next chapter, we will improve our snapchat-like messages with an expiration time to not have to rerun the app.</p><br>

    </div>
    <!-- /#page-wrapper -->
  </div>
  <!-- /#wrapper -->

  </body>

  <!-- jQuery -->
<script src="/vendor/jquery/jquery.min.js"></script>
<!-- Bootstrap Core JavaScript -->
<script src="/vendor/bootstrap/js/bootstrap.min.js"></script>

<!-- Plugin JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
<script src="/vendor/scrollreveal/scrollreveal.min.js"></script>
<script src="/vendor/magnific-popup/jquery.magnific-popup.min.js"></script>

<!-- Theme JavaScript -->
<script src="/javascripts/creative.js"></script>
<script src="/javascripts/all.js"></script>

</html>
